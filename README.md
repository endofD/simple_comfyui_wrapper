# simple_comfyui_wrapper

[ä¸­æ–‡readme](https://github.com/endofD/simple_comfyui_wrapper/raw/refs/heads/main/README_CN.md)
Simple ComfyUI backend WebSocket API wrapper  
Simple frontend + RESTful API backend  

Features:
- REST API
- User management
- Simple FIFO scheduler
- Keep images from ComfyUI output
- Comfyui separate network
- Easy and simple logic
- 2 examples for text input and image input

---

## REST API

Lightweight Flask framework.

---

## User Management

User credentials are stored in a JSON file:

```json
{
  "users": {
    "user1": "password1",
    "user2": "password2"
  }
}
```

---

## FIFO Scheduler

- Each user is allowed only **one** running instance.
- If another user is executing, the request will be queued and return the queue number.
- There is **no queue monitoring code**; you need to implement your own monitoring logic in the frontend.
- **Results are cached**. Subsequent submissions will be **ignored**, and the result will be fetched from the **cache**.

---

## All Uploads and ComfyUI Images Are Kept

- `data`: This directory stores the ComfyUI API workflows.
- `uploads`: This directory stores user-uploaded images.
- `comfyui_img`: This directory stores images generated by ComfyUI.

---

## Frontend Examples

Two examples are provided for text input and image input.

---

## Installation

1. Create a virtual environment:
   ```bash
   python -m venv venv
   source venv/bin/activate
   ```

2. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```

3. Update configuration:
   - Set `COMFYUI_SERVER_ADDRESS = "127.0.0.1:8188"`
   - Set `FLASK_ADDR = 'http://127.0.0.1:5000'`

---

## Example Screenshots

![Example Image 1](https://github.com/endofD/simple_comfyui_wrapper/raw/refs/heads/main/screen_shot/1.png)

![Example Image 2](https://github.com/endofD/simple_comfyui_wrapper/raw/refs/heads/main/screen_shot/2.png)

![Example Image 3](https://github.com/endofD/simple_comfyui_wrapper/raw/refs/heads/main/screen_shot/3.png)

![Example Image 4](https://github.com/endofD/simple_comfyui_wrapper/raw/refs/heads/main/screen_shot/4.png)

---

## Adding a New Workflow

1. Copy the workflow API file into the `data` directory.

2. Create a new route in the Flask app:
   ```python
   @app.route('/api/new_api', methods=['POST'])
   ```

3. Load/overwrite values and **fill** the **task**:
   ```python
   (prompt, ret,) = get_promp_from_json('api_test.json')
   data = request.get_json()
   text = data.get('text')
   task['prompt'] = prompt
   task['text'] = text
   task['call'] = api1
   ```

4. Define the API function:
   ```python
   def api1(task):  # t2i, input: text
       prompt = task['prompt']
       prompt['42']['inputs']['text'] = task['text']
       output_images = process_comfyui(prompt)
       (p,) = save_img_result("comfyui_img", "t2i", output_images[0])
       return f"{FLASK_ADDR}/{p}"
   ```

5. Follow this template to add new workflows.

---

Happy hacking! ðŸš€
